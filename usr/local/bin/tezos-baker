#!/bin/bash

#############################################################################
# Tezos Baker CLI
# Modern CLI tool for Tezos baker maintenance operations
#############################################################################

# Colors for better UX
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Helper functions
print_header() {
    echo -e "\n${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}\n"
}

print_info() {
    echo -e "${CYAN}ℹ${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

prompt_yes_no() {
    local prompt="$1"
    local default="$2"
    
    if [ "$default" = "y" ]; then
        read -p "$(echo -e "${CYAN}?${NC} $prompt [${GREEN}Y${NC}/n]: ")" answer
        answer=${answer:-y}
    else
        read -p "$(echo -e "${CYAN}?${NC} $prompt [y/${GREEN}N${NC}]: ")" answer
        answer=${answer:-n}
    fi
    
    [[ "$answer" =~ ^[Yy]$ ]]
}

load_env() {
    if [ -f "$(which tezos-env.sh 2>/dev/null)" ]; then
        . $(which tezos-env.sh)
    else
        print_error "tezos-env.sh not found. Please run tezos-baker-setup.sh first."
        exit 1
    fi
}

#############################################################################
# Command: help
#############################################################################

cmd_help() {
    # Load constants to get version
    load_env
    . $(which tezos-constants.sh 2>/dev/null) || TEZOS_BAKER_VERSION="unknown"
    
    echo -e "${CYAN}Tezos Baker CLI${NC} - v${TEZOS_BAKER_VERSION}"
    echo ""
    echo -e "${YELLOW}USAGE:${NC}"
    echo "    tezos-baker <command> [options]"
    echo ""
    echo -e "${YELLOW}COMMANDS:${NC}"
    echo -e "    ${GREEN}setup${NC}              Run the initial setup wizard"
    echo -e "    ${GREEN}start${NC}              Start all baker services"
    echo -e "    ${GREEN}stop${NC}               Stop all baker services"
    echo -e "    ${GREEN}restart${NC}            Restart all baker services"
    echo -e "    ${GREEN}upgrade${NC}            Upgrade tezos-baker to the latest version"
    echo -e "    ${GREEN}upgrade-tezpay${NC}     Upgrade TezPay to the latest version"
    echo -e "    ${GREEN}stake${NC}              Manage staking operations"
    echo -e "    ${GREEN}vote${NC}               Participate in Tezos governance voting"
    echo -e "    ${GREEN}history-mode${NC}       Switch node history mode"
    echo -e "    ${GREEN}enable-bls${NC}         Enable BLS/tz4 baking"
    echo -e "    ${GREEN}status${NC}             Show baker status and logs"
    echo -e "    ${GREEN}logs${NC}               View logs for selected baker components"
    echo -e "    ${GREEN}version${NC}            Show version information"
    echo -e "    ${GREEN}help${NC}               Show this help message"
    echo ""
    echo -e "${YELLOW}EXAMPLES:${NC}"
    echo "    tezos-baker setup              # Run initial setup wizard"
    echo "    tezos-baker restart            # Restart all services"
    echo "    tezos-baker upgrade            # Upgrade Octez"
    echo "    tezos-baker stake increase 100 # Stake 100 XTZ"
    echo "    tezos-baker logs baker         # View baker logs"
    echo "    tezos-baker status             # Show current status"
    echo ""
    echo -e "${YELLOW}MORE INFO:${NC}"
    echo "    For detailed documentation, see README.md"
    echo "    Report issues: https://github.com/LaBoulange/tezos-baker/issues"
    echo ""
}

#############################################################################
# Command: version
#############################################################################

cmd_version() {
    load_env
    echo -e "${CYAN}Tezos Baker${NC} v${TEZOS_BAKER_VERSION}"
    echo ""
    echo "Octez version: ${OCTEZ_VERSION}"
    echo "Network: ${NODE_NETWORK}"
    echo "Baker: ${BAKER_ACCOUNT_HASH}"
}

#############################################################################
# Command: setup
#############################################################################

cmd_setup() {
    if [ -x "$(which tezos-baker-setup.sh 2>/dev/null)" ]; then
        tezos-baker-setup.sh
    else
        print_error "tezos-baker-setup.sh not found in PATH"
        exit 1
    fi
}

#############################################################################
# Helper: Start all services
#############################################################################

start_all_services() {
    print_info "Starting Octez services..."
    start-octez.sh
    
    if [ -x "$(which start-etherlink.sh 2>/dev/null)" ]; then
        print_info "Starting Etherlink..."
        start-etherlink.sh 2>/dev/null || print_warning "Etherlink not configured, skipping"
    fi
    
    if [ -x "$(which start-tezpay.sh 2>/dev/null)" ]; then
        print_info "Starting TezPay..."
        start-tezpay.sh 2>/dev/null || print_warning "TezPay not configured, skipping"
    fi
}

#############################################################################
# Helper: Stop all services
#############################################################################

stop_all_services() {
    if [ -x "$(which stop-tezpay.sh 2>/dev/null)" ]; then
        print_info "Stopping TezPay..."
        stop-tezpay.sh 2>/dev/null || true
    fi
    
    if [ -x "$(which stop-etherlink.sh 2>/dev/null)" ]; then
        print_info "Stopping Etherlink..."
        stop-etherlink.sh 2>/dev/null || true
    fi
    
    print_info "Stopping Octez services..."
    stop-octez.sh
}

#############################################################################
# Command: start
#############################################################################

cmd_start() {
    load_env
    print_header "Starting Tezos Baker Services"
    start_all_services
    print_success "All services started successfully!"
}

#############################################################################
# Command: stop
#############################################################################

cmd_stop() {
    load_env
    print_header "Stopping Tezos Baker Services"
    stop_all_services
    print_success "All services stopped successfully!"
}

#############################################################################
# Command: restart
#############################################################################

cmd_restart() {
    load_env
    print_header "Restarting Tezos Baker Services"
    stop_all_services
    sleep 2
    start_all_services
    print_success "All services restarted successfully!"
}

#############################################################################
# Command: upgrade
#############################################################################

cmd_upgrade() {
    load_env
    
    print_header "Upgrading Octez"
    
    print_warning "This will stop all services and upgrade Octez to the latest version."
    
    if ! prompt_yes_no "Do you want to continue?" "y"; then
        print_info "Upgrade cancelled."
        exit 0
    fi
    
    # Update tezos-baker scripts
    print_info "Updating tezos-baker scripts..."
    install-tezos-baker.sh
    
    # Reload environment
    . $(which tezos-env.sh)
    
    # Stop all services
    stop_all_services
    
    # Install new version
    print_info "Installing Octez..."
    install-octez.sh
    
    # Upgrade storage if needed
    print_info "Checking if storage upgrade is needed..."
    nohup octez-node upgrade storage --config-file="$NODE_CONFIG_FILE" --data-dir="$NODE_RUN_DIR" &>"$NODE_LOG_FILE" &
    
    print_warning "Storage upgrade running in background. Check $NODE_LOG_FILE for progress."
    sleep 5
    
    # Start all services
    start_all_services
    
    print_success "Upgrade completed successfully!"
    print_info "Check for any backup directories in your home directory that may need cleanup."
}

#############################################################################
# Command: upgrade-tezpay
#############################################################################

cmd_upgrade_tezpay() {
    load_env
    
    print_header "Upgrading TezPay"
    
    if [ ! -d "$TEZPAY_RUN_DIR" ]; then
        print_error "TezPay is not configured. Run 'tezos-baker setup' first."
        exit 1
    fi
    
    print_info "Stopping TezPay..."
    stop-tezpay.sh
    
    print_info "Installing latest TezPay version..."
    install-tezpay.sh
    
    print_info "Starting TezPay..."
    start-tezpay.sh
    
    print_success "TezPay upgraded successfully!"
}

#############################################################################
# Command: stake
#############################################################################

cmd_stake() {
    load_env
    
    local action="$1"
    local amount="$2"
    
    if [ -z "$action" ]; then
        echo -e "${YELLOW}USAGE:${NC}"
        echo "    tezos-baker stake <action> [amount]"
        echo ""
        echo -e "${YELLOW}ACTIONS:${NC}"
        echo -e "    ${GREEN}increase <amount>${NC}    Stake additional XTZ"
        echo -e "    ${GREEN}decrease <amount>${NC}    Unstake XTZ (takes 2 cycles)"
        echo -e "    ${GREEN}finalize${NC}             Finalize unstaked balance (after 4 cycles)"
        echo -e "    ${GREEN}params${NC}               Update staking parameters"
        echo -e "    ${GREEN}info${NC}                 Show current staking information"
        echo ""
        echo -e "${YELLOW}EXAMPLES:${NC}"
        echo "    tezos-baker stake increase 1000"
        echo "    tezos-baker stake decrease 500"
        echo "    tezos-baker stake finalize"
        echo "    tezos-baker stake params"
        echo "    tezos-baker stake info"
        echo ""
        exit 0
    fi
    
    case "$action" in
        increase)
            if [ -z "$amount" ]; then
                print_error "Amount required. Usage: tezos-baker stake increase <amount>"
                exit 1
            fi
            
            print_header "Increasing Stake"
            print_info "Staking $amount XTZ for $KEY_BAKER..."
            
            octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" stake "$amount" for "$KEY_BAKER"
            
            print_success "Stake increased by $amount XTZ"
            ;;
            
        decrease)
            if [ -z "$amount" ]; then
                print_error "Amount required. Usage: tezos-baker stake decrease <amount>"
                exit 1
            fi
            
            print_header "Decreasing Stake"
            print_warning "Unstaking takes 2 cycles before you can finalize."
            print_info "Unstaking $amount XTZ for $KEY_BAKER..."
            
            octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" unstake "$amount" for "$KEY_BAKER"
            
            print_success "Unstake request submitted for $amount XTZ"
            print_info "You can finalize this after 4 cycles using: tezos-baker stake finalize"
            ;;
            
        finalize)
            print_header "Finalizing Unstake"
            print_info "Finalizing unstaked balance for $KEY_BAKER..."
            
            octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" finalize unstake for "$KEY_BAKER"
            
            print_success "Unstaked balance finalized"
            ;;
            
        params)
            print_header "Updating Staking Parameters"
            
            echo "Current parameters:"
            echo "  Limit of staking over baking: $BAKER_LIMIT_STAKING_OVER_BAKING"
            echo "  Edge of baking over staking: $BAKER_EDGE_BAKING_OVER_STAKING"
            echo ""
            
            print_warning "To change these values, edit $INSTALL_DIR/tezos-env.sh"
            
            if prompt_yes_no "Apply current parameters from tezos-env.sh?" "y"; then
                octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" \
                    set delegate parameters for "$KEY_BAKER" \
                    --limit-of-staking-over-baking "$BAKER_LIMIT_STAKING_OVER_BAKING" \
                    --edge-of-baking-over-staking "$BAKER_EDGE_BAKING_OVER_STAKING"
                
                print_success "Staking parameters updated"
            fi
            ;;
            
        info)
            print_header "Staking Information"
            
            octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" \
                rpc get "/chains/main/blocks/head/context/delegates/$BAKER_ACCOUNT_HASH"
            ;;
            
        *)
            print_error "Unknown action: $action"
            print_info "Run 'tezos-baker stake' for usage information"
            exit 1
            ;;
    esac
}

#############################################################################
# Command: vote
#############################################################################

cmd_vote() {
    load_env
    
    local action="$1"
    shift
    
    if [ -z "$action" ]; then
        echo -e "${YELLOW}USAGE:${NC}"
        echo "    tezos-baker vote <action> [options]"
        echo ""
        echo -e "${YELLOW}ACTIONS:${NC}"
        echo -e "    ${GREEN}info${NC}                      Show current voting period information"
        echo -e "    ${GREEN}propose <proposal...>${NC}     Submit proposal(s) (proposal period only)"
        echo -e "    ${GREEN}ballot <proposal> <vote>${NC}  Vote yay/nay/pass (exploration/promotion periods)"
        echo ""
        echo -e "${YELLOW}EXAMPLES:${NC}"
        echo "    tezos-baker vote info"
        echo "    tezos-baker vote propose PtXXXXXX"
        echo "    tezos-baker vote ballot PtXXXXXX yay"
        echo ""
        exit 0
    fi
    
    case "$action" in
        info)
            print_header "Voting Period Information"
            octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" show voting period
            ;;
            
        propose)
            if [ $# -eq 0 ]; then
                print_error "At least one proposal required. Usage: tezos-baker vote propose <proposal...>"
                exit 1
            fi
            
            print_header "Submitting Proposal(s)"
            print_info "Submitting proposals for $KEY_BAKER: $@"
            
            octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" \
                submit proposals for "$KEY_BAKER" "$@"
            
            print_success "Proposal(s) submitted"
            ;;
            
        ballot)
            local proposal="$1"
            local vote="$2"
            
            if [ -z "$proposal" ] || [ -z "$vote" ]; then
                print_error "Proposal and vote required. Usage: tezos-baker vote ballot <proposal> <yay|nay|pass>"
                exit 1
            fi
            
            if [[ ! "$vote" =~ ^(yay|nay|pass)$ ]]; then
                print_error "Vote must be 'yay', 'nay', or 'pass'"
                exit 1
            fi
            
            print_header "Submitting Ballot"
            print_info "Voting $vote for proposal $proposal"
            
            octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" \
                submit ballot for "$KEY_BAKER" "$proposal" "$vote"
            
            print_success "Ballot submitted: $vote"
            ;;
            
        *)
            print_error "Unknown action: $action"
            print_info "Run 'tezos-baker vote' for usage information"
            exit 1
            ;;
    esac
}

#############################################################################
# Command: history-mode
#############################################################################

cmd_history_mode() {
    load_env
    
    local new_mode="$1"
    
    if [ -z "$new_mode" ]; then
        echo -e "${YELLOW}USAGE:${NC}"
        echo "    tezos-baker history-mode <mode>"
        echo ""
        echo -e "${YELLOW}MODES:${NC}"
        echo -e "    ${GREEN}rolling${NC}              Rolling mode (~120GB)"
        echo -e "    ${GREEN}rolling:N${NC}            Rolling mode with N extra cycles"
        echo -e "    ${GREEN}full${NC}                 Full mode (~500GB)"
        echo ""
        echo -e "${YELLOW}CURRENT MODE:${NC}"
        echo "    $NODE_MODE"
        echo ""
        echo -e "${YELLOW}EXAMPLES:${NC}"
        echo "    tezos-baker history-mode rolling"
        echo "    tezos-baker history-mode rolling:10"
        echo "    tezos-baker history-mode full"
        echo ""
        exit 0
    fi
    
    print_header "Switching History Mode"
    
    print_warning "This will switch from '$NODE_MODE' to '$new_mode'"
    print_warning "You need to manually update NODE_MODE in $INSTALL_DIR/tezos-env.sh"
    
    if ! prompt_yes_no "Continue?" "y"; then
        print_info "Operation cancelled"
        exit 0
    fi
    
    print_info "Updating node configuration..."
    octez-node config update --config-file="$NODE_CONFIG_FILE" --data-dir="$NODE_RUN_DIR" --history-mode="$new_mode"
    
    print_info "Stopping Octez services..."
    stop-octez.sh
    
    print_info "Starting node with force-history-mode-switch..."
    nohup octez-node run --force-history-mode-switch --config-file="$NODE_CONFIG_FILE" --rpc-addr "$NODE_RPC_ADDR" --log-output="$NODE_LOG_FILE" &>/dev/null &
    
    sleep 10
    
    print_info "Starting remaining services..."
    start-octez.sh
    
    print_success "History mode switch initiated"
    print_warning "Remember to update NODE_MODE='$new_mode' in $INSTALL_DIR/tezos-env.sh"
}

#############################################################################
# Command: enable-bls
#############################################################################

cmd_enable_bls() {
    load_env
    
    print_header "Enable BLS/tz4 Baking"
    
    echo "This will enable BLS/tz4 consensus and DAL companion keys for your baker."
    echo ""
    print_warning "Make sure you have already generated and imported your tz4 keys:"
    echo "  - Consensus key alias: $KEY_CONSENSUS_TZ4"
    echo "  - DAL companion key alias: $KEY_DAL_COMPANION_TZ4"
    echo ""
    print_info "See: https://docs.tezos.com/tutorials/join-dal-baker/prepare-account"
    echo ""
    
    if ! prompt_yes_no "Have you imported your tz4 keys?" "n"; then
        print_error "Please import your tz4 keys first, then run this command again."
        exit 1
    fi
    
    print_info "Updating tezos-baker scripts..."
    install-tezos-baker.sh
    
    . $(which tezos-env.sh)
    
    print_info "Registering consensus key..."
    octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" \
        set consensus key for "$KEY_BAKER" to "$KEY_CONSENSUS_TZ4"
    
    print_info "Registering DAL companion key..."
    octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" \
        set companion key for "$KEY_BAKER" to "$KEY_DAL_COMPANION_TZ4"
    
    print_info "Verifying consensus key registration..."
    octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" \
        rpc get "/chains/main/blocks/head/context/delegates/$BAKER_ACCOUNT_HASH/consensus_key"
    
    print_info "Verifying DAL companion key registration..."
    octez-client --base-dir "$CLIENT_BASE_DIR" --endpoint "http://${NODE_RPC_ADDR}" \
        rpc get "/chains/main/blocks/head/context/delegates/$BAKER_ACCOUNT_HASH/companion_key"
    
    print_info "Restarting services..."
    stop-octez.sh
    start-octez.sh
    
    print_success "BLS/tz4 baking enabled successfully!"
}

#############################################################################
# Command: status
#############################################################################

cmd_status() {
    load_env
    
    print_header "Tezos Baker Status"
    
    echo -e "${CYAN}Configuration:${NC}"
    echo "  Network: $NODE_NETWORK"
    echo "  Baker: $BAKER_ACCOUNT_HASH"
    echo "  Alias: $KEY_BAKER"
    echo ""
    
    echo -e "${CYAN}Running Processes:${NC}"
    ps aux | grep octez | grep -v grep || echo "  No Octez processes running"
    echo ""
    
    echo -e "${CYAN}Recent Baker Log:${NC}"
    if [ -f "$BAKER_LOG_FILE" ]; then
        tail -n 10 "$BAKER_LOG_FILE"
    else
        echo "  Log file not found: $BAKER_LOG_FILE"
    fi
}

#############################################################################
# Command: logs
#############################################################################

cmd_logs() {
    load_env
    
    local component="$1"
    local lines="${2:-50}"
    
    if [ -z "$component" ]; then
        echo -e "${YELLOW}USAGE:${NC}"
        echo "    tezos-baker logs <component> [lines]"
        echo ""
        echo -e "${YELLOW}COMPONENTS:${NC}"
        echo -e "    ${GREEN}node${NC}         RPC node logs"
        echo -e "    ${GREEN}baker${NC}        Baker logs"
        echo -e "    ${GREEN}accuser${NC}      Accuser logs"
        echo -e "    ${GREEN}dal${NC}          DAL node logs"
        echo -e "    ${GREEN}tezpay${NC}       TezPay logs (if configured)"
        echo -e "    ${GREEN}etherlink${NC}    Etherlink logs (if configured)"
        echo ""
        echo -e "${YELLOW}EXAMPLES:${NC}"
        echo "    tezos-baker logs baker"
        echo "    tezos-baker logs node 100"
        echo "    tezos-baker logs dal"
        echo ""
        exit 0
    fi
    
    case "$component" in
        node)
            print_header "Node Logs (last $lines lines)"
            tail -n "$lines" "$NODE_LOG_FILE" 2>/dev/null || print_error "Log file not found: $NODE_LOG_FILE"
            ;;
        baker)
            print_header "Baker Logs (last $lines lines)"
            tail -n "$lines" "$BAKER_LOG_FILE" 2>/dev/null || print_error "Log file not found: $BAKER_LOG_FILE"
            ;;
        accuser)
            print_header "Accuser Logs (last $lines lines)"
            tail -n "$lines" "$ACCUSER_LOG_FILE" 2>/dev/null || print_error "Log file not found: $ACCUSER_LOG_FILE"
            ;;
        dal)
            print_header "DAL Node Logs (last $lines lines)"
            tail -n "$lines" "$DAL_LOG_FILE" 2>/dev/null || print_error "Log file not found: $DAL_LOG_FILE"
            ;;
        tezpay)
            print_header "TezPay Logs (last $lines lines)"
            tail -n "$lines" "$TEZPAY_LOG_FILE" 2>/dev/null || print_error "Log file not found: $TEZPAY_LOG_FILE"
            ;;
        etherlink)
            print_header "Etherlink Logs (last $lines lines)"
            tail -n "$lines" "$ETHERLINK_NODE_LOG_FILE" 2>/dev/null || print_error "Log file not found: $ETHERLINK_NODE_LOG_FILE"
            ;;
        *)
            print_error "Unknown component: $component"
            print_info "Run 'tezos-baker logs' for usage information"
            exit 1
            ;;
    esac
}

#############################################################################
# Main
#############################################################################

main() {
    local command="$1"
    shift || true
    
    case "$command" in
        help|--help|-h|"")
            cmd_help
            ;;
        version|--version|-v)
            cmd_version
            ;;
        setup)
            cmd_setup "$@"
            ;;
        start)
            cmd_start "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        restart)
            cmd_restart "$@"
            ;;
        upgrade)
            cmd_upgrade "$@"
            ;;
        upgrade-tezpay)
            cmd_upgrade_tezpay "$@"
            ;;
        stake)
            cmd_stake "$@"
            ;;
        vote)
            cmd_vote "$@"
            ;;
        history-mode)
            cmd_history_mode "$@"
            ;;
        enable-bls)
            cmd_enable_bls "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
